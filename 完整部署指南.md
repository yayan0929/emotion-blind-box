# 大学生情绪盲盒交换站 - 完整部署指南

本指南将帮助您完成前端、后端和数据库的完整部署，让所有人都可以使用您的网站。

## 第一部分：部署后端和数据库到Render

### 步骤1：准备代码

1. 将您的代码上传到GitHub（如果还没有）
2. 确保代码结构正确：
   ```
   /emotion-blind-box
     /client        # 前端代码
     /server        # 后端代码
     /shared        # 共享代码
   ```

### 步骤2：创建Render账号

1. 访问：https://render.com
2. 使用GitHub账号注册登录（推荐）

### 步骤3：创建PostgreSQL数据库

1. 登录Render后，点击"New +" → "PostgreSQL"
2. 设置参数：
   - 名称：`emotion-box-db`
   - 数据库名称：`emotionbox`
   - 用户名：`emotionbox_user`
   - 选择免费套餐（足够小型项目使用）
3. 点击"Create Database"
4. 等待数据库创建完成
5. 创建后，从数据库详情页面复制**外部连接字符串**，格式类似：
   ```
   postgres://emotionbox_user:password@hostname:5432/emotionbox
   ```
   **重要**：保存这个连接字符串，稍后会用到。

### 步骤4：创建后端服务

1. 在Render中点击"New +" → "Web Service"
2. 选择您的GitHub仓库
3. 设置以下参数：
   - **名称**：`emotion-box-api`
   - **根目录**：`server`
   - **构建命令**：`npm install && npm run build`
   - **启动命令**：`npm start`
   - **实例类型**：Free
4. 点击"Advanced Settings"
5. 在"Environment Variables"部分添加以下环境变量：

   ```
   DATABASE_URL = postgres://emotionbox_user:password@hostname:5432/emotionbox
   JWT_SECRET = emotion-blind-box-jwt-secret-key-change-in-production-2023
   JWT_REFRESH_SECRET = emotion-blind-box-refresh-secret-key-change-in-production-2023
   NODE_ENV = production
   PORT = 3001
   CORS_ORIGIN = https://your-frontend-site.netlify.app
   ```

   **注意**：
   - `DATABASE_URL`：使用步骤3中获取的连接字符串
   - `CORS_ORIGIN`：暂时留空，等部署完前端后更新
6. 点击"Create Web Service"
7. 等待部署完成（可能需要5-10分钟）
8. 部署完成后，您会获得一个类似 `https://emotion-box-api.onrender.com` 的URL
9. 保存这个URL，稍后会用到

### 步骤5：初始化数据库

1. 访问您的后端服务URL：`https://emotion-box-api.onrender.com`
2. 如果一切正常，您应该看到API响应
3. 数据库表将在第一次启动时自动创建（通过Prisma）

## 第二部分：部署前端到Netlify

### 步骤1：更新前端API配置

1. 打开 `client/src/services/api.ts` 文件
2. 找到第12行：
   ```typescript
   return 'https://your-backend-url.onrender.com/api';
   ```
3. 替换为您的实际后端URL：
   ```typescript
   return 'https://emotion-box-api.onrender.com/api';
   ```
4. 保存文件

### 步骤2：构建前端

1. 打开命令行终端
2. 进入项目目录：
   ```
   cd c:/Users/HP/CodeBuddy/239025009/client
   ```
3. 安装依赖：
   ```
   npm install
   ```
4. 构建前端：
   ```
   npm run build
   ```
   如果构建失败，尝试：
   ```
   npx vite build --mode production
   ```

### 步骤3：部署到Netlify

#### 方法一：拖拽部署（最简单）

1. 访问：https://app.netlify.com/drop
2. 将 `client/dist` 文件夹拖拽到页面中
3. 等待部署完成
4. 记录下获得的Netlify域名（如：`https://amazing-duck-123456.netlify.app`）

#### 方法二：使用Netlify CLI

1. 安装Netlify CLI：
   ```
   npm install -g netlify-cli
   ```
2. 登录Netlify：
   ```
   netlify login
   ```
3. 在client目录中运行：
   ```
   netlify deploy --prod --dir=dist
   ```

## 第三部分：更新CORS配置

### 步骤1：更新后端CORS设置

1. 返回到Render控制台
2. 找到您的后端服务（`emotion-box-api`）
3. 点击"Environment"选项卡
4. 找到`CORS_ORIGIN`变量
5. 将其更新为您的Netlify域名（例如：`https://amazing-duck-123456.netlify.app`）
6. 点击"Save Changes"保存
7. 触发一次重新部署（点击"Manual Deploy" → "Deploy Latest Commit"）

### 步骤2：验证部署

1. 访问您的Netlify网站
2. 测试注册功能
3. 测试登录功能
4. 测试创建盲盒功能
5. 测试浏览盲盒功能

## 第四部分：故障排除

### 常见问题

1. **前端无法连接到后端**
   - 检查API URL是否正确
   - 确认CORS设置是否正确
   - 查看浏览器控制台错误信息

2. **数据库连接错误**
   - 检查Render控制台中的后端服务日志
   - 确认DATABASE_URL环境变量是否正确
   - 确保数据库已创建

3. **部署失败**
   - 检查构建命令是否正确
   - 查看部署日志找出具体错误
   - 确保所有依赖都在package.json中列出

### 获取帮助

1. 查看Render和Netlify的官方文档
2. 检查浏览器控制台错误
3. 查看服务器日志

## 完成部署！

完成以上步骤后，您已经成功部署了完整的前后端应用，包括数据库。现在您可以：

1. 将Netlify网站URL分享给其他人
2. 其他人可以注册账号、登录、创建盲盒、回复盲盒
3. 您可以在Render控制台监控后端服务状态

您的"大学生情绪盲盒交换站"现在已经可以供所有人使用了！

## 补充：使用本地数据库进行测试

如果您想使用本地数据库进行测试：

1. 启动本地数据库服务
2. 使用ngrok将本地端口暴露到公网
3. 使用ngrok提供的URL作为API URL

您可以使用已提供的"配置并启动ngrok.bat"脚本来设置ngrok。